{{- /*
* Eclipse Tractus-X - Industry Core Hub
*
* Copyright (c) 2025 LKS Next
* Copyright (c) 2025 Contributors to the Eclipse Foundation
*
* See the NOTICE file(s) distributed with this work for additional
* information regarding copyright ownership.
*
* This program and the accompanying materials are made available under the
* terms of the Apache License, Version 2.0 which is available at
* https://www.apache.org/licenses/LICENSE-2.0.
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
* WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
* License for the specific language governing permissions and limitations
* under the License.
*
* SPDX-License-Identifier: Apache-2.0
*/}}
{{- if and .Values.keycloak.enabled .Values.keycloak.realmImport.enabled (eq .Values.keycloak.realmImport.method "job") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-realm-import
  namespace: {{ .Release.Namespace | default "default" | quote }}
  labels:
    {{- include "industry-core-hub.labels" . | nindent 4 }}
    app.kubernetes.io/component: keycloak-import
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        {{- include "industry-core-hub.labels" . | nindent 8 }}
        app.kubernetes.io/component: keycloak-import
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: prepare-realm
          image: python:3.11-alpine
          imagePullPolicy: IfNotPresent
          env:
            {{- range $user := .Values.keycloak.realm.users }}
            - name: {{ $user.username | upper | replace "-" "_" }}_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ $.Release.Name }}-keycloak-realm-users
                  key: {{ $user.username }}-password
            {{- end }}
          volumeMounts:
            - name: realm-data
              mountPath: /import
            - name: processed-realm
              mountPath: /output
          command:
            - /bin/sh
            - -c
          args:
            - |
              set -e
              echo "Installing bcrypt library..."
              pip install bcrypt --quiet
              
              echo "Generating password hash..."
              python3 <<'PYTHON_SCRIPT'
              import bcrypt
              import json
              import os
              import base64
              
              # Read the realm template
              with open('/import/realm-export.json', 'r') as f:
                  realm_data = json.load(f)
              
              # Get password from environment (already decoded by Kubernetes)
              password = os.environ['ICHUB_ADMIN_PASSWORD']
              
              # Generate bcrypt hash (Keycloak uses bcrypt with 10 rounds by default)
              salt = bcrypt.gensalt(rounds=10)
              password_hash = bcrypt.hashpw(password.encode('utf-8'), salt)
              
              # Prepare the secretData JSON structure
              secret_data = {
                  "value": password_hash.decode('utf-8'),
                  "salt": base64.b64encode(salt).decode('utf-8'),
                  "additionalParameters": {}
              }
              
              # Update the user credentials
              for user in realm_data.get('users', []):
                  if user.get('username') == 'ichub-admin':
                      for cred in user.get('credentials', []):
                          if cred.get('type') == 'password':
                              cred['secretData'] = json.dumps(secret_data)
              
              # Write the processed realm
              with open('/output/realm-export.json', 'w') as f:
                  json.dump(realm_data, f, indent=2)
              
              print("Password hash generated and realm template processed")
              PYTHON_SCRIPT
              
              echo "Realm template ready for import"
      containers:
        - name: realm-import
          image: curlimages/curl:8.5.0
          imagePullPolicy: IfNotPresent
          env:
            - name: KEYCLOAK_URL
              value: "http://{{ .Release.Name }}-keycloak:80"
            - name: KEYCLOAK_ADMIN
              value: "{{ .Values.keycloak.auth.adminUser }}"
            - name: KEYCLOAK_ADMIN_PASSWORD
              value: "{{ .Values.keycloak.auth.adminPassword }}"
          volumeMounts:
            - name: processed-realm
              mountPath: /import
          command:
            - /bin/sh
            - -c
          args:
            - |
              set -e
              echo "Starting realm import process..."
              
              # Wait for Keycloak to be available
              echo "Waiting for Keycloak at $KEYCLOAK_URL..."
              for i in $(seq 1 60); do
                if curl -f "$KEYCLOAK_URL/auth/realms/master" >/dev/null 2>&1; then
                  echo "Keycloak is ready!"
                  break
                fi
                echo "Attempt $i: Waiting for Keycloak..."
                sleep 10
                if [ $i -eq 60 ]; then
                  echo "ERROR: Keycloak not available after 10 minutes"
                  exit 1
                fi
              done
              
              # Get admin token
              echo "Getting admin token..."
              TOKEN=$(curl -s -X POST "$KEYCLOAK_URL/auth/realms/master/protocol/openid-connect/token" \
                -H "Content-Type: application/x-www-form-urlencoded" \
                -d "username=$KEYCLOAK_ADMIN" \
                -d "password=$KEYCLOAK_ADMIN_PASSWORD" \
                -d "grant_type=password" \
                -d "client_id=admin-cli" | \
                sed -n 's/.*"access_token":"\([^"]*\)".*/\1/p')
              
              if [ -z "$TOKEN" ]; then
                echo "ERROR: Failed to get admin token"
                exit 1
              fi
              
              # Check if realm already exists
              REALM_NAME="ICHub"
              echo "Checking if realm '$REALM_NAME' exists..."
              REALM_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer $TOKEN" \
                "$KEYCLOAK_URL/auth/admin/realms/$REALM_NAME")
              
              if [ "$REALM_EXISTS" = "200" ]; then
                echo "Realm '$REALM_NAME' already exists, skipping import"
              else
                echo "Importing realm '$REALM_NAME'..."
                curl -s -X POST "$KEYCLOAK_URL/auth/admin/realms" \
                  -H "Authorization: Bearer $TOKEN" \
                  -H "Content-Type: application/json" \
                  -d @/import/realm-export.json
                
                if [ $? -eq 0 ]; then
                  echo "Realm '$REALM_NAME' imported successfully"
                else
                  echo "ERROR: Failed to import realm '$REALM_NAME'"
                  exit 1
                fi
              fi
              
              echo "Realm import process completed!"
      volumes:
        - name: realm-data
          configMap:
            name: {{ .Release.Name }}-realm-data
        - name: processed-realm
          emptyDir: {}
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        runAsGroup: 0
        fsGroup: 0
{{- end }}
